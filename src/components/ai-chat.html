<!DOCTYPE >

<style>
    /* Chat container */
    #chat-container {
        visibility: hidden;
        background-color: #f5f5f5;
        position: fixed;
        bottom: 18px;
        right: 18px;
        width: 300px;
        height: calc(100vh - 80px);
        border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        z-index: 1000;
    }

    /* Chat header */
    #chat-header {
        background-color: #f7cc02;
        padding: 15px;
        font-size: 16px;
    }

    /* Chat messages */
    #chat-body {
        padding: 10px;
        padding-bottom: 60px;
        overflow-y: auto;
        height: calc(100vh - 164px);
    }

    /* Chat input */
    #chat-input {
        display: flex;
        position: absolute;
        bottom: 0px;
        width: 100%;
    }

    #chat-input .messageArea {
        width: 100%;
        padding: 10px;
        border: none;
        outline: none;
        resize: none;
    }

    #chat-input a {
        background-color: #111;
        color: white;
        text-align: center;
        text-decoration: none;
        padding: 10px;
        cursor: pointer;
    }

    #chat-input button {
        background-color: #111;
        color: white;
        border: none !important;
        border-radius: 0;
        padding: 10px;
        cursor: pointer;
    }

    /* Messages */
    .message {
        word-wrap: break-word; /* Breaks long words */
        word-break: break-word;
        border-radius: 8px;
    }

    .message.user {
        max-width: 70%;
        margin-left: auto;
    }

    .message.user .edit-message {
        background-color: #292929;
        border-radius: 50%;
        height: 40px;
        min-width: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        transition: background-color 0.3s ease, transform 0.3s ease;
    }

    .message.user .edit-message:hover {
        background-color: #3a3a3a; /* Slightly lighter on hover */
        transform: scale(1.1); /* Slight scaling on hover */
    }

    .message.user .edit-message i {
        display: block;
        width: 16px; /* Ensure the icon has a fixed size */
        height: 16px;
    }

    .message .user {
        background-color: #e6f7ff;
        padding: 10px;
    }

    .message.user .assitant-tools {
        display: none;
    }

    .message.assistant .edit-message {
        display: none;
    }

    .message.assistant .assitant-tools {
        display: flex;
        width: 100%;
        gap: 10px;
        margin-top: 20px;
    }

    .message.assistant .assitant-tools a:hover {
        background-color: #292929;
    }
    .message.assistant .assitant-tools a:hover {
        background-color: #292929;
    }

    .message.assistant .markdown-body {
        width: 100%;
    }

    .message.assistant .markdown-body pre[theme] {
        border-radius: 0px;
    }

    .message.assistant .markdown-body textarea[type="code"] {
        width: 100%;
        border: none;
        outline: none;
        padding: 10px;
    }

    .message img {
        width: 40px;
        height: 40px;
        display: none;
        margin-right: 10px;
    }

    .message.assistant img {
        display: block;
    }

    textarea {
        background-color: #fff;
    }

    /* Dark mode */
    @media (prefers-color-scheme: dark) {
        #chat-container {
            background-color: #333;
        }
        #chat-header {
            color: #000;
            fill: #000;
        }

        .message .user {
            background-color: #1a1a1a;
        }
        textarea {
            background-color: #222;
            color: #fff;
        }
    }
</style>

<input
    type="hidden"
    key="_id"
    localstorage-get="user_id"
    localstorage-if="false"
    localstorage-next="#createUserAI"
    localstorage-attribute="$click" />

<form array="users" object="" hidden>
    <input key="_id" localstorage-set="user_id" />
    <input key="answeredQuestions[]" value="Discover" />
    <input key="subscription" value="false" />
    <input type="checkbox" key="ambassadorTerms" />
    <a id="createUserAI" actions="timeout(1000), save, localStorage"></a>
</form>

<button
    id="chat-toggle"
    click-next
    click-attribute="style"
    click-value="visibility:visible,"
    class="button-round bottom:70px">
    <i src="../assets/svg/comment-alt.svg">ðŸ’¬</i>
</button>

<div id="chat-container" resizable>
    <div id="chat-header">
        Chat with YellowOracle
        <a
            click-closest="#chat-container"
            click-attribute="style"
            click-value="visibility:visible,"
            class="float:right font-size:20px color:#000:hover">
            <i src="../assets/svg/times.svg"></i>
        </a>
    </div>

    <div
        id="chat-body"
        class="display:flex flex-direction:column gap:36px"
        array="aiConversations"
        object
        filter-key="user_id"
        filter-value="$user_id"
        filter-limit="5"
        filter-sort-key="_id"
        filter-sort-direction="desc"
        render-selector="[template]"
        render-reverse="true"
        scroll-to=""
        observe-target=".message"
        observe-attribute="scroll-to"
        observe-value="bottom"
        scroll="bottom, false"
        scroll-element=""
        scroll-up="10"
        scroll-attribute="observe-value">
        <div filter-on="scroll" filter-parent></div>

        <div
            template
            class="message {{object.role}}"
            hover-selector=".edit-user-message"
            hover-attribute="hidden"
            hover-value="">
            <div class="display:flex gap:5px width:100%">
                <!-- Edit Message -->
                <!-- <div class="edit-user-message" click-parent="" hidden>
                    <div class="edit-message">
                        <i src="./assets/svg/pencil-alt.svg"></i>
                    </div>
                </div> -->

                <div class="display:flex width:100% {{object.role}}">
                    <img
                        src="{{path}}assets/icons/icon-1240-1240.png"
                        alt="AI Icon" />
                    <form class="width:100%">
                        <div
                            class="markdown-body"
                            value-type="html"
                            array="aiConversations"
                            object="{{object._id}}"
                            key="content"
                            read="false">
                            {{object.content}}
                        </div>

                        <!-- User Save and cancel -->
                        <!-- <div class="display:flex gap:15px padding:15px">
                            <a>Send</a>
                            <a>Cancel</a>
                        </div> -->
                        <!-- Assistant tools -->
                        <div class="assitant-tools">
                            <!-- Copy as markdown, html or text -->
                            <a>
                                <i src="./assets/svg/clone.svg"></i>
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div
        observe-target=".message.assistant textarea[type='code']"
        observe-selector="document; .message.assistant textarea:not(div + span)[]"
        observe-insert-adjacent="beforebegin">
        <div
            class="position:relative display:flex justify-content:space-between background-color:#292929 padding:10px">
            <div class="display:flex align-items:center gap:10px">
                <a class="display:flex align-items:center gap:5px"
                    ><i
                        click-selector=""
                        click-attribute="value"
                        click-insert-adjacent=""
                        click-replace=""
                        class="height:20px"
                        src="./assets/svg/chevron-left.svg"></i>
                    Insert
                </a>
                <a class="display:flex align-items:center gap:5px"
                    ><i
                        click-selector=""
                        click-attribute="value"
                        click-replace=""
                        class="height:20px"
                        src="./assets/svg/chevron-left.svg"></i>
                    Replace
                </a>
            </div>
            <div
                class="display:flex justify-content:flex-end align-items:center gap:10px">
                <a>
                    <i src="./assets/svg/clone.svg"></i>
                </a>
                <a
                    toggle-next
                    toggle-attribute="hidden"
                    toggle-value=""
                    click-closest="codearea ; textarea"
                    click-attribute="readonly"
                    click-value="">
                    <i src="./assets/svg/edit.svg"></i>
                </a>
                <span hidden>
                    <a
                        toggle-closest="codearea ; textarea"
                        toggle-attribute="readonly"
                        toggle-value=""
                        click-closest=".markdown-body"
                        click-attribute="$save">
                        <i src="./assets/svg/save.svg"></i>
                    </a>
                    <a
                        click-closest=".markdown-body"
                        click-attribute="readonly"
                        click-value="">
                        <i src="./assets/svg/ban.svg"></i>
                    </a>
                </span>
                <a>
                    <i src="./assets/svg/eye.svg"></i>
                </a>
            </div>
        </div>
    </div>

    <form id="chat-input" api="openai">
        <input
            openai="chat.completions.create"
            openai-key="model"
            value="gpt-4o"
            hidden />

        <input
            openai="chat.completions.create"
            openai-key="messages[0].role"
            value="system"
            hidden />
        <textarea
            array="ai"
            object
            key="content"
            save="false"
            filter-key="name"
            filter-value="Web Developer"
            openai="chat.completions.create"
            openai-key="messages[0].content"
            reset="object"
            skip-attribute
            hidden></textarea>

        <previousConversation>
            <input
                filter-key="user_id"
                filter-value="$user_id"
                filter-sort-key="_id"
                filter-sort-direction="desc"
                filter-next
                hidden />

            <!-- TODO: Needs to merge with with message array -->
            <textarea
                id="messagetest"
                array="aiConversations"
                object
                key="{}"
                save="false"
                value-type="array"
                openai="chat.completions.create"
                openai-key="messages[]"
                reset="object"
                skip-attribute
                hidden></textarea>
        </previousConversation>

        <input
            array="aiConversations"
            object
            key="user_id"
            value="$user_id"
            hidden />
        <input
            array="aiConversations"
            object
            key="role"
            openai="chat.completions.create"
            openai-key="messages[a].role"
            value="user"
            hidden />
        <span
            array="aiConversations"
            object
            key="content"
            openai="chat.completions.create"
            openai-key="messages[a].content"
            reset="object"
            hidden></span>
        <!-- <textarea
            array="aiConversations"
            object
            key="content"
            openai="chat.completions.create"
            openai-key="messages[a].content"
            placeholder="Message YellowOracle"
            rows="1"
            auto-rows
            class="messageArea"
            onkeydown="if (event.key === 'Enter') this.nextElementSibling.click()"></textarea> -->
        <textarea
            placeholder="Message YellowOracle"
            input-previous
            input-attribute="value"
            input-if="true"
            rows="1"
            height="auto"
            class="messageArea"
            onkeydown="if (event.key === 'Enter') this.nextElementSibling.click()"></textarea>

        <button
            id="send-message"
            actions="save, click, reset, openai.chat.completions.create, action(document; #aiAction)"
            click-selector="document; #chat-body"
            click-attribute="observe-value"
            click-value="bottom">
            <i src="./assets/svg/paper-plane.svg"></i>
        </button>

        <textarea
            openai="chat.completions.create"
            openai-key="choices[0].message.content"
            openai-request="false"
            input-selector="document; #aiContent"
            input-attribute="value"
            marked
            hidden></textarea>
    </form>

    <form
        id="assistant-message"
        array="aiConversations"
        object
        hidden
        class="position:fixed top:0 left:0 background-color:black">
        <input key="user_id" value="$user_id" update="false" />
        <input id="testrole" key="role" value="assistant" update="false" />
        <input key="eid" />
        <div id="aiContent" component key="content"></div>
        <a id="aiAction" actions="save, reset"></a>
    </form>

    <div resize="left"></div>
    <div resize="top"></div>
</div>

<!-- <script>
    let selectedElement = null;

    // Simulate element selection
    document.body.addEventListener("click", (event) => {
        if (selectedElement) {
            selectedElement.classList.remove("selected-element");
        }
        selectedElement = event.target;
        selectedElement.classList.add("selected-element");
    });
</script> -->

<!-- <script>
    console.log('test')
    const chatBody = document.getElementById('chat-body');
    if (chatBody) {
        // Auto-scroll to bottom when a new message is added
        const observer = new MutationObserver(scrollToBottom);
        observer.observe(chatBody, { childList: true });

        // Scroll chat body to the bottom
        function scrollToBottom() {
            chatBody.scrollTop = chatBody.scrollHeight;
        }
    }
</script> -->
<script>
    document.addEventListener(
        "input",
        function (event) {
            if (
                event.target.tagName === "TEXTAREA" &&
                event.target.getAttribute("height") === "auto"
            )
                autoResizeTextarea(event.target);
        },
        false
    );

    function autoResizeTextarea(textarea) {
        if (!textarea.style.height) observeTextareaResize(textarea);
        textarea.style.height = "auto";

        // Get the scrollHeight, which is the full height of the content, including overflow
        const scrollHeight = textarea.scrollHeight;

        // Set the height of the textarea to the scrollHeight
        textarea.style.height = scrollHeight + "px";
    }

    function observeTextareaResize(textarea) {
        let previousWidth = textarea.offsetWidth;

        const resizeObserver = new ResizeObserver((entries) => {
            for (let entry of entries) {
                const currentWidth = entry.contentRect.width;

                if (currentWidth !== previousWidth) {
                    previousWidth = currentWidth;
                    autoResizeTextarea(textarea);
                }
            }
        });

        resizeObserver.observe(textarea);
    }
</script>
