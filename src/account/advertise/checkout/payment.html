<form class="flex-form">
	<div
		class="display:flex justify-content:space-between width:100% margin-bottom:20px">
		<h3>Add to credit balance</h3>
		<i
			actions="state"
			state_to="mainView"
			state-src="./account/advertise/"
			src="./assets/svg/times.svg">
		</i>
	</div>

	<!-- Payment Amount -->
	<floating-label class="width:100%">
		<div class="padding-left:14px">$</div>

		<!-- User Input Field -->
		<input
			type="number"
			id="amountInput"
			class="floating-label"
			min="50"
			placeholder="Enter amount (min $50)" />

		<div
			class="display:flex align-items:center gap:5px width:170px font-size:14px"
			click-closest="#sales"
			click-attribute="display"
			click-value="auto-top-up">
			<i src="./assets/svg/cog.svg"></i>
			<span class="margin-top:2px"> Auto Top-Up </span>
		</div>

		<!-- Processed Amount (in cents) -->
		<input
			id="amountInCents"
			type="number"
			calculate="{(#amountInput)} * 100"
			stripe="paymentIntents.create"
			stripe-key="amount"
			required
			hidden />
	</floating-label>

	<!-- Section: Auto-Recharge Details -->
	<!-- <div
		id="auto-top-up"
		class="border:1px solid #ddd padding:20px border-radius:10px">
		<h3>Auto-Recharge</h3>

		<div class="recurring-details">
			<p>Recharge Amount: <span id="recurring-amount">$50.00</span></p>
			<p>Threshold Amount: <span id="threshold-amount">$10.00</span></p>
			<p>Current Status: <span id="recurring-status">Enabled</span></p>
		</div>

		<button
			click-closest="#sales"
			click-attribute="display"
			click-value="auto-top-up"
			class="btn-primary margin-top:10px">
			Auto Top-Up
		</button>
	</div> -->

	<!-- Customer ID -->
	<input
		type="hidden"
		class="customer"
		stripe="paymentIntents.create"
		stripe-key="customer"
		required />

	<!-- Currency -->
	<input
		type="hidden"
		stripe="paymentIntents.create"
		stripe-key="currency"
		value="usd" />

	<!-- Automatic Payment Methods -->
	<input
		type="hidden"
		stripe="paymentIntents.create"
		stripe-key="automatic_payment_methods.enabled"
		value="true" />

	<input
		type="hidden"
		stripe="paymentIntents.create"
		stripe-key="automatic_payment_methods.allow_redirects"
		value="never" />

	<!-- Confirmation -->
	<input
		type="hidden"
		stripe="paymentIntents.create"
		stripe-key="confirm"
		value="true" />

	<payment-method-container class="width:100%">
		<input
			type="hidden"
			stripe="paymentMethods.list"
			stripe-key="type"
			value="card" />
		<input
			type="hidden"
			class="customer"
			stripe="paymentMethods.list"
			stripe-key="customer"
			input-next
			input-attribute="$click" />
		<a
			id="loadPaymentMethods"
			actions="stripe.paymentMethods.list, stripe.customers.retrieve"></a>

		<input
			class="customer"
			type="hidden"
			stripe="customers.retrieve"
			stripe-key="$param[0]" />

		<style>
			payment-method-list.open > payment-method {
				display: flex;
			}
		</style>

		<floating-label
			class="margin-bottom:10px"
			click-attribute="class"
			click-value="open"
			click-selector="payment-method-list">
			<div
				stripe="paymentIntents.create"
				stripe-key="payment_method"
				value=""
				placeholder="Payment Method">
				<input
					id="defaultPaymentId"
					type="hidden"
					stripe="customers.retrieve"
					stripe-key="invoice_settings.default_payment_method"
					stripe-request="false"
					input-attribute="value"
					input-parent />

				<payment-method-list
					class="display:flex flex-direction:column gap:10px"
					stripe="paymentMethods.list"
					stripe-key="data"
					stripe-request="false"
					value-type="array"
					render="data"
					render-selector="[template]">
					<!-- Template for Individual Payment Method -->
					<payment-method
						template
						click-attribute="value"
						click-value="{{data.id}}"
						click-closest="[stripe-key='payment_method']"
						value="{{data.id}}"
						class="card display:none align-items:center order:1 padding:10px!important height:70px cursor:pointer">
						<style>
							payment-method-list[value="{{object._id}}"]
								> payment-method[value="{{object._id}}"] {
								display: flex;
								order: 0;
							}
							div[value="{{data.id}}"]
								payment-method[value="{{data.id}}"] {
								display: flex;
								order: 0;
							}
							#defaultPaymentId[value="{{data.id}}"]
								~ payment-method-list
								payment-method[value="{{data.id}}"]
								.default-card-label {
								display: block;
								font-weight: bold;
							}
						</style>

						<!-- Icon for Card Brand -->
						<i
							src="./assets/svg/cc-{{data.card.brand}}.svg"
							class="width:40px height:40px margin-right:15px"></i>

						<!-- Card Details -->
						<div class="flex-grow:1">
							<div class="font-weight:bold font-size:16px">
								.... {{data.card.last4}}
							</div>
							<div class="font-size:12px">
								Expires
								{{data.card.exp_month}}/{{data.card.exp_year}}
							</div>
						</div>

						<!-- Default Card Label -->
						<div
							value="{{data.id}}"
							class="default-card-label display:none padding-top:2px font-size:12px">
							<span> Default </span>
						</div>

						<div
							class="display:inline-flex align-items:center"
							hover-selector=".card"
							hover-attribute="class"
							hover-value="display:block!important"
							hover-stopPropagation
							click-attribute=""
							click-stopPropagation>
							<div
								class="card display:none position:absolute right:35px height:70px wdth:108px padding:10px!important font-size:14px line-height:1.9 transition:0.3s box-shadow:unset!important">
								<div
									actions="click, remove"
									click-attribute="value"
									click-value="{{data.id}}"
									click-document="#detachPaymentMethod"
									click-stopPropagation
									remove-closest="payment-method">
									Remove Card
								</div>
								<div
									click-attribute="value"
									click-value="{{data.id}}"
									click-document="#setDefaultPaymentMethod, document; #defaultPaymentId">
									<div
										click-attribute="$click"
										click-closest="payment-method">
										Set as default
									</div>
								</div>
							</div>
							<i
								class="padding-left:10px"
								src="./assets/svg/ellipsis-v.svg"></i>
						</div>
					</payment-method>
				</payment-method-list>
			</div>
		</floating-label>

		<div class="display:flex justify-content:flex-end width:100%">
			<div
				class="display:flex gap:10px"
				click-closest="#sales"
				click-attribute="display"
				click-value="payment-method">
				<i src="./assets/svg/plus.svg"></i>
				<span class="padding-top:2px"> Add payment method </span>
			</div>
		</div>
	</payment-method-container>

	<!-- Transfer Destination (Also Dynamically Gets Stripe Attribute) -->
	<input
		type="hidden"
		array="users"
		object="$user_id"
		key="ambassadorAccount"
		stripe-key="transfer_data.destination"
		class="ambassador-target"
		input-next
		input-attribute="object"
		hidden />

	<!-- Ambassador Condition (Controls When Stripe Attributes Are Applied) -->
	<input
		id="ambassador"
		type="checkbox"
		class="ambassador"
		array="ambassadors"
		object=""
		key="charges_enabled"
		input-attribute="stripe"
		input-selector="ambassador-target[]"
		input-value="paymentIntents.create"
		input-if="true"
		hidden />

	<!-- Application Fee Amount (Dynamically Gets Stripe Attribute) -->
	<input
		type="number"
		calculate="Math.round(({(#amountInCents)} * 15) / 100)"
		stripe-key="application_fee_amount"
		class="ambassador-target"
		hidden />

	<textarea
		id="ambassadorParents"
		array="users"
		object="$user_id"
		key="ambassadorParents"
		value-type="json"
		class="input-field"
		hidden></textarea>

	<!-- Submit Button -->
	<button
		actions="validate, click, stripe.paymentIntents.create, timeout(2000), save, click, timeout(2000), click"
		click-selector="i"
		click-attribute="src"
		click-value="../assets/svg/spinner.svg, ../assets/svg/check-circle.svg, ../assets/svg/save.svg"
		class="width:100%">
		<i src="../assets/svg/save.svg"></i>
		<span class="margin-left:5px">Confirm Payment</span>
	</button>

	<!-- Error/Success Response -->
	<div template="validate, stripe.paymentIntents.create" class="response">
		<span class="{{status}}">{{message}}</span>
	</div>
</form>

<form hidden>
	<input
		id="detachPaymentMethod"
		stripe="paymentMethods.detach"
		stripe-key="$param[0]"
		input-attribute="$click"
		input-next />
	<div actions="stripe.paymentMethods.detach"></div>
</form>

<form hidden>
	<!-- Input for the Customer ID -->
	<input
		type="hidden"
		class="customer"
		stripe="customers.update"
		stripe-key="$param[0]" />
	<!-- Input for the Default Payment Method (pm_id) -->
	<input
		id="setDefaultPaymentMethod"
		stripe="customers.update"
		stripe-key="invoice_settings.default_payment_method"
		input-attribute="$click"
		input-next />

	<!-- Action triggered when the Default Payment Method is set -->
	<div actions="stripe.customers.update"></div>
</form>
