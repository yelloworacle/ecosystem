<!DOCTYPE html>

<div class="display:flex justify-content:center width:100% padding-top:80px">
    <style>
        /* Add a CSS animation to make the icon spin */
        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Apply the animation to the icon with a class */
        [src="./assets/svg/spinner.svg"] {
            animation: spin 2s linear infinite; /* Adjust the duration and other properties as needed */
        }

        input[type="button"] {
            display: none;
        }
        input.question {
            padding-bottom: 15px;
            padding-right: 85px;
        }

        input[type="button"] + a {
            padding: 15px 30px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease,
                border 0.3s ease;
            border: 2px solid #f7cc02;
            background-color: #f0f0f0;
            border-radius: 8px;
            position: relative;
            z-index: 5;
            left: 0px;
            top: 5px;
            width: 100%;
            display: block;
        }

        input[type="button"] + a:hover {
            background-color: #f7cc02;
        }

        input[type="button"] + a span {
            display: none !important;
        }
        input[type="button"] + a i {
            display: none !important;
        }
        .Intro {
            display: block;
            width: 100%;
        }

        .question[type="hidden"] ~ .sibling {
            display: none;
        }

        .hidden-input {
            position: absolute;
            opacity: 0;
            width: 1px;
            height: 1px;
            z-index: -1;
        }
    </style>
    <div
        class="display:flex flex-direction:column gap:15px width:100% min-width:275px max-width:600px">
        <!-- <div
            array="questions"
            object
            fiter-sort-key="position"
            filter-limit="0"
            component></div> -->

        <section>
            <div
                filter-sort-key="position"
                filter-sort-direction="asc"
                filter-parent="#questions"></div>

            <textarea
                id="answeredQuestions"
                array="users"
                object="$user_id"
                key="answeredQuestions"
                filter-key="name"
                filter-operator="$nin"
                filter-next
                value-type="json"
                realtime="false"
                input-attribute="read"
                input-value="true"
                input-next
                hidden></textarea>

            <div
                id="questions"
                storage="mongodb"
                array="questions"
                object
                filter-limit="1"
                render-selector="#temp"
                read="false"
                loader>
                <form
                    id="temp"
                    realtime="false"
                    array="users"
                    object="$user_id"
                    template
                    broadcast="false">
                    <input
                        id="answeredQuestion"
                        type="hidden"
                        key="answeredQuestions[]"
                        value="{{object.name}}"
                        read="false" />

                    <label
                        for="{{object.name}}"
                        class="load-value font-size:18px"
                        >{{object.question}}</label
                    >
                    <div class="position:relative margin-top:5px">
                        <input
                            id="{{object.name}}"
                            type="{{object.type}}"
                            key="{{object.name}}"
                            name="{{object.name}}"
                            autocomplete="{{object.name}}"
                            read="false"
                            {{object.attributes}}
                            onkeydown="if (event.key === 'Enter') this.nextElementSibling.click()"
                            required
                            class="question" />
                        <a
                            actions="{{object.actions}}"
                            click-selector="i[src]"
                            click-attribute="src"
                            click-value="./assets/svg/spinner.svg"
                            class="sibling display:flex position:absolute top:9px right:8px font-size:20px">
                            <span class="margin-right:5px font-weight:400"
                                >Enter</span
                            >
                            <i src="./assets/svg/angle-right.svg"></i>
                            <div class="{{object.name}}" hidden>
                                Begin Your Journey
                            </div>
                        </a>

                        <div class="sibling progress-bar">
                            <div
                                position="{{object.position}}"
                                class="progress"
                                style="width: 0px"></div>
                        </div>
                    </div>
                    <div
                        template="validate"
                        class="card margin:5px padding:10px {{status}}">
                        <span class="{{type}}">{{message}}</span
                        ><a actions="remove"> X</a>
                    </div>
                </form>
            </div>
        </section>

        <section>
            <input
                type="hidden"
                localstorage-get="subscription"
                localstorage-parent="#subscription"
                localstorage-attribute="object" />

            <textarea
                id="subscription"
                array="subscriptions"
                object=""
                realtime="false"
                key="fields"
                input-next="[template] #subscribed"
                input-attribute="value"
                class="width:100%"
                hidden
                save="false"></textarea>

            <div
                id="careers"
                array=""
                object
                filter-sort-key="name"
                render-selector="[template]">
                <div class="card margin-bottom:15px" template>
                    <div class="card-content">
                        <div class="card-row full-width">
                            <span class="card-label">Career Name:</span>
                            <span class="card-value load-value"
                                >{{object.name}}</span
                            >
                        </div>
                        <div class="card-row">
                            <span class="card-label">Average Salary:</span>
                            <span class="card-value load-value"
                                >{{object.salary}}</span
                            >
                        </div>
                        <div class="card-row">
                            <span class="card-label">Stress Level:</span>
                            <span class="card-value load-value"
                                >{{object.stress}}</span
                            >
                        </div>

                        <div class="card-row">
                            <span class="card-label">Pros:</span>
                            <span class="card-value load-value"
                                >{{object.pros}}</span
                            >
                        </div>
                        <div class="card-row">
                            <span class="card-label">Cons:</span>
                            <span class="card-value load-value"
                                >{{object.cons}}</span
                            >
                        </div>
                        <div class="card-row full-width">
                            <span class="card-label">Interesting Fact:</span>
                            <span class="card-value load-value"
                                >{{object.facts}}</span
                            >
                        </div>

                        <div class="card-row">
                            <span class="card-label">Apprentice:</span>
                            <span class="card-value load-value"
                                >{{object.apprentice}}</span
                            >
                        </div>
                        <div class="card-row">
                            <span class="card-label">Satisfaction:</span>
                            <span class="card-value load-value"
                                >{{object.satisfaction}}</span
                            >
                        </div>
                        <div class="card-row full-width">
                            <span class="card-label">Sacrifices:</span>
                            <span class="card-value load-value"
                                >{{object.sacrifices}}</span
                            >
                        </div>

                        <div class="card-row full-width">
                            <span class="card-label">Characteristics:</span>
                            <span class="card-value load-value"
                                >{{object.characteristics}}</span
                            >
                        </div>
                        <div class="card-row full-width">
                            <span class="card-label"
                                >Career Path Variability:</span
                            >
                            <span class="card-value load-value"
                                >{{object.careerPathVariability}}</span
                            >
                        </div>
                        <div id="subscribed" class="width:100%">
                            <button
                                class="unlock width:100% margin-top:20px font-size:16px">
                                <a state_to="mainView" state-src="./checkout/"
                                    >Subscribe to unlock additional details</a
                                >
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <form>
        <div
            array="ai"
            object
            filter-key="type"
            filter-value="system"
            openai="system"
            save="false"
            component></div>
        <div
            array="users"
            object="$user_id"
            key="questions"
            openai="user"
            save="false"
            component></div>
        <div
            array="users"
            object="$user_id"
            key="careers"
            openai="user"
            save="false"
            component></div>
        <textarea
            id="response"
            value-type="json"
            openai="response"
            hidden></textarea>
        <a id="request" actions="openAi, manageCareers"></a>
    </form>

    <textarea
        id="mergedCareers"
        array="users"
        object="$user_id"
        key="careers"
        value-type="json"
        crdt="false"
        broadcast="false"
        filter-key="name"
        filter-operator="$in"
        filter-selector="document; #careers"
        filter-case-sensitive="false"
        value-type="json"
        input-attribute="array"
        input-value="careers"
        input-selector="document; #careers"
        hidden></textarea>

    <!-- <form realtime="false" array="users" object broadcast="false" hidden>
        <input type="hidden" key="_id" localstorage-set="user_id" />
        <input type="hidden" key="answeredQuestions[]" value="Discover" />
        <button id="createUser" actions="save, localStorage"></button>
    </form> -->

    <script src="./oracle/index.js"></script>
    <script src="./oracle/progress.js"></script>
    <script>
        let user_id = localStorage.getItem("user_id");
        if (!user_id) {
            console.log("test");
            document.getElementById("answeredQuestions").setValue("Discover");
            CoCreate.crud
                .send({
                    method: "object.create",
                    array: "users",
                    object: {
                        "answeredQuestions[]": "Discover",
                        ambassadorTerms: false,
                    },
                })
                .then((user) => {
                    if (user.object[0]) {
                        localStorage.setItem("user_id", user.object[0]._id);
                        let userElements = document.querySelectorAll(
                            "[array='users']:not([ambassador])"
                        );

                        userElements.forEach(function (element) {
                            element.setAttribute("object", user.object[0]._id);
                        });
                    }
                });
        }

        CoCreate.observer.init({
            name: "setEmailInput",
            observe: ["addedNodes"],
            target: "#password",
            callback: async (mutation) => {
                const email = document.createElement("input");
                email.type = "email";
                email.id = "email";
                email.name = "email";
                email.classList.add("hidden-input");
                email.setAttribute("array", "users");
                email.setAttribute("object", "");
                email.setAttribute("key", "email");
                email.setAttribute("autocomplete", "email");
                mutation.target.parentElement.appendChild(email);

                const roles = document.createElement("input");
                roles.type = "hidden";
                roles.id = "roles";
                roles.setAttribute("array", "users");
                roles.setAttribute("object", "");
                roles.setAttribute("key", "roles[]");
                roles.value = "657726510fee1c6415f70760";
                mutation.target.parentElement.appendChild(roles);

                let ambassadorId = localStorage.getItem("ambassador");
                if (ambassadorId) {
                    const ambassador = document.createElement("input");
                    ambassador.type = "hidden";
                    ambassador.id = "amabassador";
                    ambassador.setAttribute("array", "users");
                    ambassador.setAttribute("object", "");
                    ambassador.setAttribute("key", "ambassador");
                    ambassador.value = ambassadorId;
                    mutation.target.parentElement.appendChild(ambassador);
                }
            },
        });
    </script>
</div>
